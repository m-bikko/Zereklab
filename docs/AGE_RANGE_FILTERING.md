# Система фильтрации возрастных диапазонов

## Обзор

Система фильтрации возрастных диапазонов в ZerekLab использует числовую логику вместо простого строкового сравнения для более точного поиска товаров.

## Стандартные форматы

Система поддерживает три стандартных возрастных диапазона:

- **6-8** - для детей 6-8 лет
- **9-12** - для детей 9-12 лет  
- **13+** - для подростков и взрослых (13+ лет)

## Как это работает

### На уровне API (`app/api/products/route.ts`)

Когда пользователь выбирает фильтр возрастного диапазона, API использует регулярные выражения для поиска товаров:

```javascript
if (ageRange === '13+') {
  filter.ageRange = {
    $regex: '^13\\+$|^1[3-9]\\+$|^[2-9][0-9]\\+?$|^([1-9][3-9]|[2-9][0-9])$|^1[3-9]-|^[2-9][0-9]-',
    $options: 'i'
  };
}
```

Это означает, что фильтр "13+" найдет товары с возрастом:
- `13+`, `14+`, `20+` (форматы с плюсом)
- `13`, `14`, `15`, `20`, `25` (чистые числа ≥13)
- `13-15`, `20-25` (диапазоны, начинающиеся с 13+)

### На уровне компонентов

Используются утилитные функции из `lib/ageUtils.ts`:

```typescript
import { formatAgeRangeForDisplay } from '@/lib/ageUtils';

// Форматирование для отображения
formatAgeRangeForDisplay('20') // → "13+ лет" 
formatAgeRangeForDisplay('6-8') // → "6-8 лет"
```

## Нормализация данных

### Автоматическая нормализация

Скрипт `scripts/normalize-age-ranges.js` приводит все существующие данные к стандартному формату:

```bash
npm run normalize-ages
```

### Примеры нормализации

- `"20"` → `"13+"`
- `"14+"` → `"13+"`
- `"10"` → `"9-12"`
- `"7"` → `"6-8"`
- `"6-8"` → `"6-8"` (без изменений)

## Компоненты

### Фильтры (`components/ProductFilters.tsx`)

Отображает радио-кнопки для выбора возрастного диапазона.

### Админ-панель (`components/admin/ProductManagement.tsx`)

Использует выпадающий список вместо текстового поля для обеспечения консистентности.

### Отображение товаров

Все компоненты используют `formatAgeRangeForDisplay()` для единообразного отображения:

- `components/ProductGrid.tsx`
- `components/ProductDetailsModal.tsx`
- `app/products/[id]/page.tsx`

## Преимущества новой системы

1. **Точность**: Товар с возрастом "20" теперь корректно попадает в фильтр "13+"
2. **Консистентность**: Все компоненты используют единый формат
3. **Гибкость**: Система понимает различные форматы ввода
4. **UX**: Пользователи видят логичные результаты фильтрации

## Добавление новых возрастных диапазонов

Для добавления нового диапазона:

1. Обновите `AGE_RANGE_OPTIONS` в `lib/ageUtils.ts`
2. Добавьте логику в API (`app/api/products/route.ts`)
3. Обновите функцию нормализации
4. Обновите выпадающие списки в компонентах

## Тестирование

Проверить работу фильтров можно через API:

```bash
# Фильтр 13+
curl "http://localhost:3000/api/products?ageRange=13%2B&simple=true"

# Фильтр 6-8
curl "http://localhost:3000/api/products?ageRange=6-8&simple=true"
```

Или через веб-интерфейс на странице `/products`. 